<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/png" sizes="48x48" href="./overops-favicon-48x48.png"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://getbootstrap.com/docs/4.5/examples/dashboard/dashboard.css" crossorigin="anonymous">

    <style>
      .navbar-brand {
        background-color: unset;
        box-shadow: unset;
      }
      .modal {
        display: block;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>

    <title>OverOps Pod Patcher</title>
  </head>

  <body>
    <div x-data="model()" x-init="init()">
      <nav class="navbar navbar-dark sticky-top bg-dark p-0">
        <a class="navbar-brand col-3 mr-0 px-3" href="">OverOps Pod Patcher</a>
        <button
          class="btn btn-sm btn-outline-light ml-auto mr-2"
          type="button"
          @click.prevent="
            isConfigOpen = true;
            $nextTick(() => $refs.modalConfig.focus());
          ">
          Configure agent
        </button>
        <button
          class="btn btn-sm btn-light mr-3"
          x-bind:disabled="numChecked < 1"
          type="button"
          @click.prevent="
            getPatch(false);
            isReviewOpen = true;
            $nextTick(() => $refs.modalReview.focus());
          ">
          <span class="badge badge-dark mr-1" x-text="numChecked"></span>
          Review patch
        </button>
      </nav>

      <div class="container-fluid">
        <div class="row">
          <nav id="sidebarMenu" class="col-3 d-block bg-light sidebar">
            <div class="sidebar-sticky pt-3">

              <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                <span>Namespace</span>
              </h6>

              <ul class="nav flex-column">
                <template x-if="namespaces.length > 0" x-for="ns in namespaces">
                  <li class="nav-item" :key="ns.metadata.name">
                    <a
                      href="#"
                      class="nav-link"
                      :class="{ 'active': namespace === ns.metadata.name }"
                      @click.prevent="setNamespace(ns.metadata.name)"
                      @keydown.escape="isReviewOpen = false"
                      x-text="ns.metadata.name"
                    ></a>
                  </li>
                </template>
              </ul>
            </div>
          </nav>

          <main role="main" class="col-9 ml-auto px-4">
            <div class="pt-3 pb-2 mb-3">
              <h3>Deployments</h3>
            </div>

            <template x-if="deployments.length > 0">
              <div>
                <template x-for="(dep, d) in deployments" :key="d">
                  <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <div class="form-check user-select-none">
                        <label class="form-check-label">
                          <input class="form-check-input" type="checkbox" x-model="dep.isChecked" @click.prevent="toggleDeployment(d)">
                          <span class="font-weight-bold" x-text="dep.metadata.name"></span> &ndash;
                          <span class="font-italic" x-text="dep.metadata.labels.app"></span>
                        </label>
                      </div>
                      <template x-if="dep.spec.template.spec.initContainers">
                        <div class="mr-auto ml-2">
                          <template x-for="(initContainer, ic) in dep.spec.template.spec.initContainers" :key="ic">
                            <div x-show="initContainer.image.startsWith('overops/agent-sidecar')">
                              <span class="badge badge-dark" x-text="initContainer.image"></span>
                            </div>
                          </template>
                        </div>
                    </template>
                    <div class="d-flex align-items-center">
                      <span
                        x-show="dep.metadata.annotations"
                        class="font-weight-light"
                        x-text="`rev ${dep.metadata.annotations['deployment.kubernetes.io/revision']}`"
                      ></span>
                    </div>
                  </div>
                  <div class="card-body">
                    <template x-for="(container, c) in dep.spec.template.spec.containers" :key="c">
                      <div>
                        <div class="form-check card-text mb-1 user-select-none">
                          <label class="form-check-label">
                            <input class="form-check-input" type="checkbox" x-model="container.isChecked" @click.prevent="toggleContainer(d,c)">
                            <span x-text="container.name"></span> &ndash;
                            <span class="font-weight-light" x-text="container.image"></span>
                          </label>

                          <span
                            class="badge badge-primary"
                            x-show="container.ENV_TAKIPI_APPLICATION_NAME"
                            x-text="`app: ${container.ENV_TAKIPI_APPLICATION_NAME}`"
                          ></span>
                          <span
                            class="badge badge-primary"
                            x-show="container.ENV_TAKIPI_DEPLOYMENT_NAME"
                            x-text="`dep: ${container.ENV_TAKIPI_DEPLOYMENT_NAME}`"
                          ></span>
                          <span
                            class="badge badge-info"
                            x-show="container.ENV_TAKIPI_COLLECTOR_HOST"
                            x-html="`<span class='text-monospace'>${container.ENV_TAKIPI_COLLECTOR_HOST}:${container.ENV_TAKIPI_COLLECTOR_PORT}</span>`"
                          ></span>
                        </div>

                        <div class="row" x-show="container.isChecked">
                          <div class="col-md-6 ml-4 mt-3">

                            <div class="form-group" x-show="container.isChecked">
                              <label class="mb-1" x-bind:id="`app-name-${d}-${c}`">Application name</label>
                              <input type="text" class="form-control form-control-sm" x-model="container.TAKIPI_APPLICATION_NAME" x-bind:id="`app-name-${d}-${c}`">
                            </div>

                            <div class="form-group" x-show="container.isChecked">
                              <label class="mb-1" x-bind:id="`dep-name-${d}-${c}`">Deployment name</label>
                              <input type="text" class="form-control form-control-sm" x-model="container.TAKIPI_DEPLOYMENT_NAME" x-bind:id="`dep-name-${d}-${c}`">
                            </div>

                          </div>
                        </div>

                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>

            <template x-if="deployments.length === 0">
              <p>No deployments</p>
            </template>

          </main>

          <div
            class="modal fade show"
            x-show.transition.in.duration.500ms="isConfigOpen"
            tabindex="-1"
            role="dialog"
            @keydown.escape="isConfigOpen = false"
            x-ref="modalConfig"
          >
            <div class="modal-dialog modal-dialog-scrollable" @click.away="isConfigOpen = false">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Configure agent</h5>
                  <button type="button" class="close" @click="isConfigOpen = false">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">

                  <div class="form-group">
                    <label class="mb-1" for="agent-version">Agent version</label>
                    <input type="text" class="form-control form-control-sm" x-model="agent" id="agent-version" placeholder="4.50.2">
                  </div>
                  <div class="form-group">
                    <label class="mb-1" for="collector-host">Collector host</label>
                    <input type="text" class="form-control form-control-sm" x-model="collectorHost" id="collector-host" placeholder="overops-collector-service">
                  </div>
                  <div class="form-group">
                    <label class="mb-1" for="collector-port">Collector port</label>
                    <input type="text" class="form-control form-control-sm" x-model="collectorPort" id="collector-port" placeholder="6060">
                  </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-sm btn-primary" @click="isConfigOpen = false">Close</button>
                </div>
              </div>
            </div>
          </div>

          <div
            class="modal fade show"
            x-show.transition.in.duration.500ms="isReviewOpen"
            tabindex="-1"
            role="dialog"
            @keydown.escape="isReviewOpen = false"
            x-ref="modalReview"
          >
            <div class="modal-dialog modal-dialog-scrollable" @click.away="isReviewOpen = false">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Review patch</h5>
                  <button type="button" class="close" @click="isReviewOpen = false">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <pre x-text="JSON.stringify(patches, null, 2)"></pre>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-sm btn-link mr-auto" @click="getPatch(true)">Disable OverOps</button>
                  <button type="button" class="btn btn-sm btn-primary" @click="applyPatch()">Apply patch</button>
                </div>
              </div>
            </div>
          </div>

        </div> <!-- /.row -->
      </div> <!-- /.container-fluid -->
      <div class="modal-backdrop fade show" x-show="isReviewOpen || isConfigOpen"></div>
    </div> <!-- /. alpine data -->
    <script>
      function model() {
        const apiPrefix = 'api/v1/';
        return {
          namespaces: [],
          namespace: 'default',
          deployments: [],
          numContainers: 0,
          numChecked: 0,
          isConfigOpen: false,
          isReviewOpen: false,
          agent: '4.50.2',
          collectorHost: 'overops-collector-service',
          collectorPort: '6060',
          patches: [],

          init() {
            fetch(apiPrefix + 'namespaces')
              .then(response => response.json())
              .then(data => this.namespaces = data.body.items);

            this.getDeployments();
          },

          setNamespace(namespace) {
            this.namespace = namespace;
            this.getDeployments();
          },

          getDeployments() {
            fetch(`${apiPrefix}namespaces/${this.namespace}/deployments`)
              .then(response => response.json())
              .then(data => {
                this.deployments = data.body.items;
                this.getNumContainers();
                this.getTakipiEnvVars();
              });
          },

          getNumContainers() {
            let numContainers = 0;
            this.deployments.forEach(deployment => {
              numContainers += deployment.spec.template.spec.containers.length;
            });
            this.numContainers = numContainers;
            this.numChecked = 0;
          },

          getNumChecked() {
            let numChecked = 0;
            this.deployments.forEach(deployment => {
              deployment.spec.template.spec.containers.forEach(container => {
                if (container.isChecked) numChecked++;
              });
            });
            this.numChecked = numChecked;
          },

          getTakipiEnvVars() {
            this.deployments.forEach(deployment => {
              deployment.spec.template.spec.containers.forEach(container => {
                if (container.env) {
                  container.env.forEach(env => {
                    switch(env.name) {
                      case 'TAKIPI_APPLICATION_NAME':
                        container.ENV_TAKIPI_APPLICATION_NAME = env.value;
                        container.TAKIPI_APPLICATION_NAME = env.value;
                        break;
                      case 'TAKIPI_DEPLOYMENT_NAME':
                        container.ENV_TAKIPI_DEPLOYMENT_NAME = env.value;
                        container.TAKIPI_DEPLOYMENT_NAME = env.value;
                        break;
                      case 'TAKIPI_COLLECTOR_HOST': container.ENV_TAKIPI_COLLECTOR_HOST = env.value; break;
                      case 'TAKIPI_COLLECTOR_PORT': container.ENV_TAKIPI_COLLECTOR_PORT = env.value; break;
                    }
                  });
                }
              });
            });
          },

          toggleDeployment(d) {
            this.deployments[d].isChecked = !this.deployments[d].isChecked;

            this.deployments[d].spec.template.spec.containers.forEach(container => {
              container.isChecked = this.deployments[d].isChecked;
            });

            this.getNumChecked();
          },

          toggleContainer(d,c) {
            this.deployments[d].spec.template.spec.containers[c].isChecked = 
              !this.deployments[d].spec.template.spec.containers[c].isChecked;

            this.numChecked += (this.deployments[d].spec.template.spec.containers[c].isChecked ? 1 : -1);

            let allContainersChecked = true;

            this.deployments[d].spec.template.spec.containers.forEach(container => {
              allContainersChecked = allContainersChecked && container.isChecked;
            });

            this.deployments[d].isChecked = allContainersChecked;
          },

          getPatch(remove) {
            let deployments = [];

            this.deployments.forEach(deployment => {
              let dep = {
                name: deployment.metadata.name,
                agent: this.agent,
                remove: remove,
                containers: []
              };

              deployment.spec.template.spec.containers.forEach(container => {
                if (container.isChecked) {
                  let con = {
                    name: container.name,
                    env: [
                      {
                        name: 'TAKIPI_COLLECTOR_HOST',
                        value: (remove ? null : this.collectorHost)
                      },
                      {
                        name: 'TAKIPI_COLLECTOR_PORT',
                        value: (remove ? null : this.collectorPort)
                      }
                    ]
                  };

                  if (remove) {
                    con.env.push({
                      name: 'TAKIPI_APPLICATION_NAME',
                      value: null
                    });
                  } else if (container.TAKIPI_APPLICATION_NAME && container.TAKIPI_APPLICATION_NAME.trim() !== "") {
                    con.env.push({
                      name: 'TAKIPI_APPLICATION_NAME',
                      value: container.TAKIPI_APPLICATION_NAME.trim()
                    });
                  }

                  if (remove) {
                    con.env.push({
                      name: 'TAKIPI_DEPLOYMENT_NAME',
                      value: null
                    });
                  } else if (container.TAKIPI_DEPLOYMENT_NAME && container.TAKIPI_DEPLOYMENT_NAME.trim() !== "") {
                    con.env.push({
                      name: 'TAKIPI_DEPLOYMENT_NAME',
                      value: container.TAKIPI_DEPLOYMENT_NAME.trim()
                    });
                  }

                  dep.containers.push(con);
                }
              });

              if (dep.containers.length > 0) {
                deployments.push(dep);
              }

            });

            this.patches = deployments;
          },

          applyPatch() {
            let patches = [];
            this.patches.forEach(patch => {
              patches.push(
                fetch(`${apiPrefix}namespaces/${this.namespace}/deployments/${patch.name}`,
                  {
                    method: 'PATCH',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patch)
                  }
                )
              );
            });

            Promise.all(patches)
              .then(() => {
                this.isReviewOpen = false;
                this.getDeployments();
              });
          },

        }
      }
    </script>

  </body>
</html>
